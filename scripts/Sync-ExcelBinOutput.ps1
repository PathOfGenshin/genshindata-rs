# This script uses quicktype to generate serde_json compatible Rust structs from
# GenshinData's ExcelBinOutput folder JSON files.
# Quicktype tool for reference: https://github.com/quicktype
$logicalCoreCount = (Get-CimInstance Win32_ComputerSystem).NumberOfLogicalProcessors
Get-ChildItem -Path ".\GenshinData\ExcelBinOutput\" -Filter *.json |
ForEach-Object -Parallel {
    $fileName = [System.IO.Path]::GetFileNameWithoutExtension($_)
    $outFile = ".\genshindata-rs\src\excelbinoutput\$fileName.rs"
    Write-Host "Running quicktype on $($_.FullName)" -ForegroundColor green
    quicktype $_.FullName `
        -t $fileName `
        -l rs `
        -o $outFile `
        --density normal `
        --visibility public `
        --derive-debug `
        --telemetry disable `
        --quiet
    $quicktypeContents = Get-Content -Raw -Path $outFile
    $typeNameRegex = "extern crate serde_derive;(?:`n.*?)+pub type ([a-zA-Z0-9]+) =.*?;"
    [void]($quicktypeContents -match $typeNameRegex)
    $typeName = $matches[1]
    $replacement = $quicktypeContents -Replace "\/\/ Example code that(\n|.)*?\/\/ }", `
@"
// This file was automatically generated by quicktype and a custom PowerShell script
// (see Sync-ExcelBinOutput.ps1 for more info).
// DO NOT manually edit this file!
"@

@"
$($replacement.Trim())

pub fn load() -> Result<$typeName, crate::json::JsonError> {
    let path: std::path::PathBuf = [
        "GenshinData",
        "ExcelBinOutput",
        "$fileName.json",
    ]
    .iter()
    .collect();
    crate::json::load_json(path)
}
"@ | Out-File $outFile
} -ThrottleLimit $logicalCoreCount

# Run Sync-ExcelBinOutput-Mod
. "$PSScriptRoot\Sync-ExcelBinOutput-Mod.ps1"
